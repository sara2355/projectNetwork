
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.Socket;
import javax.swing.*;
import java.awt.*;


public class Client {
    private static final String SERVER_IP = "localhost";
    private static final int SERVER_PORT = 9090;
    
    private JFrame startFrame, loginFrame, playersFrame, waitingRoomFrame, gameFrame;
    private DefaultListModel<String> playerListModel, waitingRoomListModel, scoreModel;
    private JList<String> playerList, waitingRoomList, scoreList;
    private PrintWriter out;
    private BufferedReader in;
    private String username;
private JLabel waitingRoomTimerLabel;
private JLabel gameTimerLabel;

  private JLabel questionLabel;
private JPanel answerButtonsPanel;


    public Client() {
        showStartWindow();
    }
//start gui
    
    
    
    // Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    private void showStartWindow() {
        startFrame = new JFrame("Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©");
        startFrame.setSize(300, 200);
        startFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        startFrame.setLayout(new BorderLayout());
        
        JLabel welcomeLabel = new JLabel("Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù„Ø¹Ø¨Ø© Ø®ÙØ²Ø¹Ø¨ÙÙ„ÙØ©!", SwingConstants.CENTER);
        welcomeLabel.setFont(new Font("Arial", Font.BOLD, 16));
        startFrame.add(welcomeLabel, BorderLayout.CENTER);
        
        JButton startButton = new JButton("Ø§Ø¨Ø¯Ø£");
        startButton.setBackground(Color.BLUE);
        startButton.setForeground(Color.WHITE);
        startButton.setFont(new Font("Arial", Font.BOLD, 14));
        startFrame.add(startButton, BorderLayout.SOUTH);
        
        startButton.addActionListener(e -> {
            startFrame.dispose();
            showLoginWindow();
        });
        
        startFrame.setVisible(true);
    }

    // Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    private void showLoginWindow() {
        loginFrame = new JFrame("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        loginFrame.setSize(300, 200);
        loginFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        loginFrame.setLayout(new BorderLayout());
        
        JLabel nameLabel = new JLabel("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ:", SwingConstants.CENTER);
        nameLabel.setFont(new Font("Arial", Font.BOLD, 14));
        loginFrame.add(nameLabel, BorderLayout.CENTER);
        
        JTextField nameField = new JTextField();
        loginFrame.add(nameField, BorderLayout.NORTH);
        
        JButton connectButton = new JButton("Ø§ØªØµÙ„");
        connectButton.setBackground(Color.BLUE);
        connectButton.setForeground(Color.WHITE);
        connectButton.setFont(new Font("Arial", Font.BOLD, 14));
        loginFrame.add(connectButton, BorderLayout.SOUTH);
        
        connectButton.addActionListener(e -> {
            username = nameField.getText().trim();
            if (!username.isEmpty()) {
                loginFrame.dispose();
                connectToServer();
                showPlayersWindow();
            }
        });
        
        loginFrame.setVisible(true);
    }

    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
    private void connectToServer() {
        try {
            Socket socket = new Socket(SERVER_IP, SERVER_PORT);
            out = new PrintWriter(socket.getOutputStream(), true);
            in  = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ±
            out.println(username);
            
            // Ø¨Ø¯Ø¡ Thread Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±
            new Thread(() -> {
                try {
                    String serverMessage;
                    while ((serverMessage = in.readLine()) != null) {
                        processMessage(serverMessage);
                    }
                } catch (IOException e) {
                    System.err.println("ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
                }
            }).start();
        } catch (IOException e) {
            JOptionPane.showMessageDialog(null, "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…!", "Ø®Ø·Ø£", JOptionPane.ERROR_MESSAGE);
        }
    }

    // Ù†Ø§ÙØ°Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
    private void showPlayersWindow() {
        playersFrame = new JFrame("Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†");
        playersFrame.setSize(400, 300);
        playersFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        playersFrame.setLayout(new BorderLayout());
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        playerListModel = new DefaultListModel<>();
        playerList = new JList<>(playerListModel);
        playerList.setBackground(Color.LIGHT_GRAY);
        playerList.setFont(new Font("Arial", Font.BOLD, 14));
        JScrollPane playersScrollPane = new JScrollPane(playerList);
        playersScrollPane.setPreferredSize(new Dimension(150, 0));
        playersFrame.add(playersScrollPane, BorderLayout.CENTER);
        
        JButton playButton = new JButton("Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨");
        playButton.setBackground(Color.BLUE);
        playButton.setForeground(Color.WHITE);
        playButton.setFont(new Font("Arial", Font.BOLD, 14));
        playersFrame.add(playButton, BorderLayout.SOUTH);
        
        
        playButton.addActionListener(e -> {
            sendPlayRequest();
            playersFrame.dispose();
            showWaitingRoom();
        });
        
        playersFrame.setVisible(true);
    }


    // Ù†Ø§ÙØ°Ø© ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    private void showWaitingRoom() {
    waitingRoomFrame = new JFrame("ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±");
    waitingRoomFrame.setSize(400, 300);
    waitingRoomFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
    waitingRoomFrame.setLayout(new BorderLayout());

    // ğŸ•’ Ø§Ù„ØªØ§ÙŠÙ…Ø± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    waitingRoomTimerLabel = new JLabel("ÙŠØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„ ... Ø«Ø§Ù†ÙŠØ©", SwingConstants.CENTER);
    waitingRoomTimerLabel.setFont(new Font("Arial", Font.BOLD, 16));
    waitingRoomTimerLabel.setForeground(Color.BLUE);
    waitingRoomFrame.add(waitingRoomTimerLabel, BorderLayout.NORTH);

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    waitingRoomListModel = new DefaultListModel<>();
    waitingRoomList = new JList<>(waitingRoomListModel);
    waitingRoomList.setBackground(Color.LIGHT_GRAY);
    waitingRoomList.setFont(new Font("Arial", Font.BOLD, 14));
    JScrollPane waitingScrollPane = new JScrollPane(waitingRoomList);
    waitingRoomFrame.add(waitingScrollPane, BorderLayout.CENTER);
    waitingRoomFrame.setVisible(true);
    
  



}

   


    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
    private void sendAnswer(boolean isCorrect) {
        if (out != null) {
            out.println("ANSWER: " + (isCorrect ? "true" : "false"));
        }
    }

    // Ø¨Ø¯Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
  
private void startGameWindow(String[] players) {
    gameFrame = new JFrame("ğŸ® Ø§Ù„Ù„Ø¹Ø¨Ø©");
    gameFrame.setSize(600, 450);
    gameFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
    gameFrame.setLayout(new BorderLayout(10, 10));

    JLabel gameLabel = new JLabel("Ø®Ø²Ø¹Ø¨Ù„Ø©", SwingConstants.CENTER);
    gameLabel.setFont(new Font("Arial", Font.BOLD, 22));
    gameFrame.add(gameLabel, BorderLayout.NORTH);

    scoreModel = new DefaultListModel<>();
    scoreList = new JList<>(scoreModel);
    scoreList.setFont(new Font("Arial", Font.BOLD, 16));
    scoreList.setBackground(new Color(250, 250, 250));
    gameFrame.add(new JScrollPane(scoreList), BorderLayout.WEST);

    for (String player : players) {
        scoreModel.addElement(player + " - 0");
    }

   // ====== Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ³Ø· ======
questionLabel = new JLabel("Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„...", SwingConstants.CENTER);
questionLabel.setFont(new Font("Arial", Font.BOLD, 18));
gameFrame.add(questionLabel, BorderLayout.CENTER);

// ====== Ø§Ù„ØªØ§ÙŠÙ…Ø± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† ======
gameTimerLabel = new JLabel("Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: 45 Ø«Ø§Ù†ÙŠØ©");
gameTimerLabel.setFont(new Font("Arial", Font.BOLD, 14));
gameTimerLabel.setForeground(Color.RED);
gameTimerLabel.setHorizontalAlignment(SwingConstants.RIGHT);

JPanel topPanel = new JPanel(new BorderLayout());
topPanel.add(gameTimerLabel, BorderLayout.EAST);
topPanel.setBorder(BorderFactory.createEmptyBorder(5, 10, 5, 10)); // Ù‡ÙˆØ§Ù…Ø´

gameFrame.add(topPanel, BorderLayout.NORTH);

    // ============ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ============
    JButton trueButton = new JButton("âœ” ØµØ­");
    styleButton(trueButton, new Color(39, 174, 96));
    trueButton.addActionListener(e -> {
        sendAnswer(true);
        disableAnswerButtons();
    });

    JButton falseButton = new JButton("âœ– Ø®Ø·Ø£");
    styleButton(falseButton, new Color(231, 76, 60));
    falseButton.addActionListener(e -> {
        sendAnswer(false);
        disableAnswerButtons();
    });

    answerButtonsPanel = new JPanel(new FlowLayout());
    answerButtonsPanel.add(trueButton);
    answerButtonsPanel.add(falseButton);

    // ============ Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ ============
    JButton leaveButton = new JButton("Ø®Ø±ÙˆØ¬");
    leaveButton.setBackground(Color.RED);
    leaveButton.setForeground(Color.WHITE);
    leaveButton.setFont(new Font("Arial", Font.BOLD, 14));
    leaveButton.setPreferredSize(new Dimension(80, 30));
    leaveButton.addActionListener(e -> sendLeaveRequest());

    JPanel bottomPanel = new JPanel(new BorderLayout());
    JPanel leftPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
    leftPanel.add(leaveButton);
    bottomPanel.add(leftPanel, BorderLayout.WEST);
    bottomPanel.add(answerButtonsPanel, BorderLayout.CENTER);

    gameFrame.add(bottomPanel, BorderLayout.SOUTH);

    if (waitingRoomFrame != null) waitingRoomFrame.dispose();

    gameFrame.setLocationRelativeTo(null);
    gameFrame.setVisible(true);
}


    private void styleButton(JButton button, Color color) {
        button.setBackground(color);
        button.setForeground(Color.WHITE);
        button.setFont(new Font("Arial", Font.BOLD, 14));
        button.setFocusPainted(false);
        button.setBorder(BorderFactory.createEmptyBorder(10, 20, 10, 20));
    }

  
  
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·
    private void updateScores(String[] scores) {
        SwingUtilities.invokeLater(() -> {
            scoreModel.clear();
            for (String s : scores) {
                scoreModel.addElement(s);
            }
        });
    }

    //end gui 
    
    
    
    
    
    
    
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    private void processMessage(String message) {
    System.out.println("Received from server: " + message);

    if (message.startsWith("PLAYERS:")) {
        String players = message.substring(8).trim();
        updatePlayersList(players);
    } else if (message.startsWith("WAITING ROOM:")) {
        String players = message.substring(13).trim();
        updateWaitingRoomList(players);
    } else if (message.startsWith("START_GAME_WITH:")) {
        String playersStr = message.substring("START_GAME_WITH:".length()).trim();
        String[] players = playersStr.split(",");
        startGameWindow(players);
    } else if (message.startsWith("QUESTION:")) {
        String question = message.substring("QUESTION:".length()).trim();
        SwingUtilities.invokeLater(() -> {
            questionLabel.setText(question);
            enableAnswerButtons();
        });
    } else if (message.startsWith("SCORE_UPDATE:")) {
        String[] scores = message.substring("SCORE_UPDATE:".length()).trim().split(",");
        updateScores(scores);
    } else if (message.startsWith("WINNER:")) {
        String winner = message.substring(7).trim();
        SwingUtilities.invokeLater(() -> {
            // Ù†Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
            gameFrame.getContentPane().removeAll();
            // Ù†Ø¹Ø±Ø¶ Ø§Ù„ÙØ§Ø¦Ø²
            JLabel winnerLabel = new JLabel("ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ: " + winner + " ğŸ‰", SwingConstants.CENTER);
            winnerLabel.setFont(new Font("Arial", Font.BOLD, 30));
            winnerLabel.setForeground(Color.GREEN);
            gameFrame.getContentPane().add(winnerLabel, BorderLayout.CENTER);
            gameFrame.revalidate();
            gameFrame.repaint();
        });
    } else if (message.startsWith("TIMER:")) {
        int seconds = Integer.parseInt(message.substring("TIMER:".length()).trim());
        startWaitingRoomTimer(seconds);
        } else if (message.startsWith("GAME_TIMER:")) {
    int secondsLeft = Integer.parseInt(message.substring("GAME_TIMER:".length()).trim());
    SwingUtilities.invokeLater(() -> 
        gameTimerLabel.setText("Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: " + secondsLeft + " Ø«Ø§Ù†ÙŠØ©"));
    } else if (message.startsWith("Player left:")) {
    String playerName = message.substring("Player left:".length()).trim();
    SwingUtilities.invokeLater(() -> {
        JOptionPane.showMessageDialog(null, "ğŸ“¢ Ø§Ù„Ù„Ø§Ø¹Ø¨ " + playerName + " Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©.", "Ù„Ø§Ø¹Ø¨ ØºØ§Ø¯Ø±", JOptionPane.INFORMATION_MESSAGE);

        // Ù†Ø­Ø°Ù Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³ÙƒÙˆØ±
        for (int i = 0; i < scoreModel.size(); i++) {
            String item = scoreModel.getElementAt(i);
            if (item.startsWith(playerName + " ")) { // Ù…Ø«Ù„Ø§ "Ahmad - 3"
                scoreModel.remove(i);
                break;
            }
        }
    });
}
    }

    private void enableAnswerButtons() {
    for (Component comp : answerButtonsPanel.getComponents()) {
        comp.setEnabled(true);
    }
}

private void disableAnswerButtons() {
    for (Component comp : answerButtonsPanel.getComponents()) {
        comp.setEnabled(false);
    }
}


    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
    private void updatePlayersList(String players) {
        SwingUtilities.invokeLater(() -> {
            playerListModel.clear();
            String[] playerNames = players.split(",");
            for (String player : playerNames) {
                player = player.trim();
                if (!player.isEmpty()) {
                    playerListModel.addElement(player);
                }
            }
        });
    }

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    private void updateWaitingRoomList(String players) {
        SwingUtilities.invokeLater(() -> {
            waitingRoomListModel.clear();
            String[] playerNames = players.split(",");
            for (String player : playerNames) {
                player = player.trim();
                if (!player.isEmpty()) {
                    waitingRoomListModel.addElement(player);
                }
            }
        });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…ØºØ§Ø¯Ø±Ø© Ù„Ù„Ø³ÙŠØ±ÙØ±
private void sendLeaveRequest() {
    if (out != null) {
        out.println("LEAVE");
    }
    // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    if (playersFrame != null) playersFrame.dispose();
    if (waitingRoomFrame != null) waitingRoomFrame.dispose();
    if (gameFrame != null) gameFrame.dispose();
    JOptionPane.showMessageDialog(null, "Ù„Ù‚Ø¯ ØºØ§Ø¯Ø±Øª Ø§Ù„Ù„Ø¹Ø¨Ø©.", "Ù…ØºØ§Ø¯Ø±Ø©", JOptionPane.INFORMATION_MESSAGE);
    System.exit(0);
}

    // Ø¯Ø§Ù„Ø© ØªØ¶ÙŠÙ Ø²Ø± Ø®Ø±ÙˆØ¬ ØªØ­Øª ÙŠØ³Ø§Ø± Ø£ÙŠ Ù†Ø§ÙØ°Ø©
private void addLeaveButton(JFrame frame) {
    JButton leaveButton = new JButton("Ø®Ø±ÙˆØ¬");
    leaveButton.setBackground(Color.RED);
    leaveButton.setForeground(Color.WHITE);
    leaveButton.setFont(new Font("Arial", Font.BOLD, 14));
    leaveButton.setPreferredSize(new Dimension(80, 30)); // Ø­Ø¬Ù… Ø§Ù„Ø²Ø±

    leaveButton.addActionListener(e -> sendLeaveRequest());

    JPanel bottomPanel = new JPanel(new FlowLayout(FlowLayout.LEFT)); // ÙŠØ³Ø§Ø±
    bottomPanel.add(leaveButton);
    frame.add(bottomPanel, BorderLayout.SOUTH);
}

    
    private void startWaitingRoomTimer(int seconds) {
    new Thread(() -> {
        try {
            for (int i = seconds; i >= 0; i--) {
                final int timeLeft = i;
                SwingUtilities.invokeLater(() -> 
                    waitingRoomTimerLabel.setText("ÙŠØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„ " + timeLeft + " Ø«Ø§Ù†ÙŠØ©")
                );
                Thread.sleep(1000);
            }
        } catch (InterruptedException ex) {
            ex.printStackTrace();
        }
    }).start();
}

    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù„Ø¹Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
    private void sendPlayRequest() {
        if (out != null) {
            out.println("play");
        } else {
            System.err.println("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù„Ø¹Ø¨: out ØºÙŠØ± Ù…Ù‡ÙŠØ£.");
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> new Client());
    }
}
